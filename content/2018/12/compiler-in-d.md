---
title: "君もDでx86_64向けCコンパイラを書こう"
date: 2018-12-11
tags:
- dlang
- tech
---

これは
[D言語 Advent Calendar 2018](https://qiita.com/advent-calendar/2018/dlang)
11日目の記事です。

この記事を通して、
自分は読者であるあなたに**D言語で**Cコンパイラを書いてもらえるように全力で説得していきます。

### d9cc : A Small C Compiler Written in D

ここ最近9ccのコミットログをたどってCコンパイラを書いていました。

[kotet/d9cc: A Small C Compiler Written in D](https://github.com/kotet/d9cc)

この記事を読んだのが書き始めた理由でした。

[1人でがんばる自作Cコンパイラ](https://www.utam0k.jp/blog/2018/10/12/r9cc/)

前々からコンパイラとか書いてみたいし、アセンブリも読めるようになりたいな、
とは思って定期的に勉強しようとしていましたが、
どうも途中でくじけてしまって毎回同じところをぐるぐるしていました。
そこで上の記事を見て、なるほどそういう勉強法もあるんだなあと思い、
書き始めてみたら結構うまくいったのです。

### なぜCコンパイラを書くのか

しかしなぜいまさらx86_64向けCコンパイラなどというありふれたものを作るのでしょうか？
実はある種の分野の勉強をするのにCコンパイラは最適な題材なのです。

プログラミングの学習を始めたばかりの時、コンパイラは一種魔法のように見えました。
テキストデータであるプログラムの「構造を解析して」、「意味を与え」、「機械語に翻訳」する？！
そんなことが本当に可能なのでしょうか？

かなり前に「コンピュータは論理の世界と現実の世界をどのようにつないでいるのですか？」
といったような質問をYahoo!知恵袋で見たことがあります。
その人にとってコンピュータはまさに魔法であり、異世界と通じあい問いと答えを交換するゲートだったのです。
それと同じことが自分にも、コンパイラにおいて起きていました。

#### 幅広い知識が自然に身につく

Cコンパイラを書くことで様々な知識を身につけることができて、
コンピュータの学習曲線の大きなジャンプを乗り越えることができます。
以下、自分が特に理解できて嬉しかったことを書いていきます。

##### アセンブリ

以前コンパイラを書こうと思った時は、
まずアセンブリを読めるようになろうと思ってアセンブリ手書きから学習をはじめました。
しかしいきなりアセンブリを学ぼうとすると前提知識が大量に必要になり、
Hello Worldの文面を書き換える程度の改造しかできませんでした。

まずx86_64の基本的な考え方を知らないので、
命令単体のリファレンスを読んでもそれが結局何をしたいのか理解できず、
したがってコードの意図が全くわからないのです。
そもそもアセンブリでは他の高級言語と違い、入門としてHello Worldを書くのは難しいことかもしれません。

9ccは非常に単純なアセンブリから出発しており、しかも期待される実行結果がテストとして書かれています。
プログラムに書いてあることがそのコードを生成するのに必要なすべてなので、
学習範囲をその中に書いてあることだけに絞ることができます。
また、プログラムは本質的にアセンブリを書いていく手順を表しているので、
アセンブリのこの行になぜこの命令があるのか、ということを理解する助けになります。

コンパイル対象のC言語が難しくなっていくにつれてアセンブリも長く複雑になっていきますが、
1コミットあたりの変更は少ないのでその場その場で学ばなければいけないことは非常に少なくなります。
実際1コミットあたりで学んだ命令は平均して1個未満といった感じだったと思います。

##### パーサー

1つづつコミットを読んでいくといきなり「
[再帰下降構文解析](https://ja.wikipedia.org/wiki/%E5%86%8D%E5%B8%B0%E4%B8%8B%E9%99%8D%E6%A7%8B%E6%96%87%E8%A7%A3%E6%9E%90)
器を作る」というコミットが現れます。
そこそこ行数が多くて苦労しましたが、その時点でのコンパイル対象はカッコもないただの四則演算だったので、
それを処理するパーサーも十分小さく、無事に理解できました。

##### 意味解析

パースを行うと構文木ができあがります。
これを書き換えたりすることでさまざまな処理を行います。
意味解析、という言葉は具体的に何をすればいいのかわかりにくいです。
コンパイラについて述べた文章でも意味解析については抽象的な説明が行われることが多く、
なんだか魔法のような印象を受けます。

しかし具体的なコードを理解したあとにその一連の処理に「意味解析」という名前をつける、
という順番だと自然に理解できました。
たぶん実際に意味解析という言葉ができたときもこういう順番だったのではないかと思います。

#### 色んな応用の世界が広がる

一度Cコンパイラの具体的実装を理解すると、それを応用してさまざまなものが作れるとわかります。
まず他の言語やISAに対するコンパイラを書くことができます。
今到達している範囲で定数畳み込みはまだ出てきていませんが、
今までのコードからどんなものを書けばいいか大体推測できます。
さらに、式変形を自動で行うタイプのプログラムもだいたい作れそうな気がしてきます。
あと[malloc動画](https://www.youtube.com/watch?v=0-vWT-t0UHg)
の言ってることが理解できるようになりました。

Cコンパイラを作ったことによって、その知識を応用できるようになり、
作れるものの範囲が一気に広がりました。
すべてはもはや魔法ではなくなり、理解できる技術になったのです。
作りたいものがいろいろあるので、今から非常に楽しみです。

### 9ccと「低レイヤを知りたい人のための Cコンパイラ作成入門」の相違点

d9ccを書いている途中で「低レイヤを知りたい人のための Cコンパイラ作成入門」の一部が
[公開されました](https://www.sigbus.info/compilerbook/)が、
9ccはこの本と作成過程が異なるようです。
本ではスタックマシンを作っていましたが、9ccでははじめからレジスタマシンを書き始めています。
スタックにまかせていた部分を自分で書いているわけですが、そんなに難しいとも思わなかったので、
人によっては自分のように9ccのコミットログをたどる学習法のほうがしっくりくるかもしれません。

### なぜD言語なのか

Cコンパイラを書くメリットは上のとおりですが、ではなぜD言語でなければいけないのでしょうか？
一般的には他の言語で書いてもいいし、C言語で書けばセルフホストができます。
しかし自分にはD言語を使う理由があります。

#### 前例がある

Cコンパイラくらいは[brainf*ckですら作れる](http://shinh.skr.jp/elvm/8cc.c.eir.bf)
のでこれはそんなに重要ではないですが、
D言語で書かれたコンパイラがたくさんあります。
まずD言語のコンパイラDMDそのものがD言語で書かれています。
自分以外にも9ccを元にD言語でコンパイラを書いた人もいます。
これはコミットログを順にたどっている自分とは違い、今のバージョンを直接Dに移植したもののようです。
ビルドツールとしてDUBを使っていたり、こちらのほうがD言語感が強いかもしれません。

#### C言語に近い

D言語は「[C言語風の構文を持つ静的型付け言語](http://www.kmonos.net/alang/d/)」であり、
基本的には高機能なCとして書くことができます。
コピペにならないようにC以外の言語を使いたかったのですが、
一方でC言語から離れすぎると書き直すのが大変になるので、
C言語と似ていながらC++のように完全な互換性があるわけでもないD言語は妥当な選択肢のひとつでした。

#### 書き慣れている

そしてこれが最も大きな理由かもしれません。
自分はD言語を書き慣れていました。
先程話したように自分はコンパイラを作ろうとして何度も挫折してきました。
できればセルフホストとかしてみたいですが、
まず一度スタンダードなものを完成させられないようでは、応用もできません。

なので今回こそは成功させようと、「Cコンパイラを作る」以外のあらゆる点で背伸びをせず、
「まず一度完成させること」を大事にしました。
言語選択においてもそれを考慮した結果、言語特有の問題で詰んだりしないような、
書き慣れているD言語が選ばれました。

D言語は非常に書きやすく、やりたいことを実現するのがとても簡単な言語です。
あなたもCとは比べ物にならないほどの安全性に守られながらコンパイラを書きましょう。

### Cコンパイラを書け

Cコンパイラは書くだけで大量の知識が手に入る最強の教材です。
そしてD言語は書くだけで救われる最強の言語です。
したがって全人類はD言語でCコンパイラを書くべきです。

自分はCコンパイラを書いて得た知識で作ってみたいものがいろいろできたので今後はそれを書きます。
言語やISAを変えて別のコンパイラを作ってみてもいいかもしれません。

以下はd9ccのコミットログを整形したものです。
途中調べたサイトなどのリンクが残してあるので、
コンパイラが作りたくなったら参考にするといいかもしれません。

### 日記（コミットログ）
